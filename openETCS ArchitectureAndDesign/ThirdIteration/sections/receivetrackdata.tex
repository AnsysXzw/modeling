%-----------------------------------------------------------------------
\subsection{Manage\_TrackSideInformation\_Integration}
%-----------------------------------------------------------------------
%\tbc
%Bernd Hekele

The block ``Manage\_TrackSideInformation\_Integration'' is responsible for receiving Eurobalise-telegrams and Euroradio-messages from the API and perform several consistency checks on the input.

The block collects the telegrams of balises in order to build balise group messages. Euroradio messages are always delivered as a whole message. 

On each message, a consistency check is performed, before the data is validated according to the driving direction of the train. In general, messages not designated for the current driving direction of the train are not forwarded to the further processing.

After applying consistency checks, the data direction is validated.

%Information of the odometer is used to control for the train leaving the expectation window of the balises. % TODO makes not much sense here.

\begin{figure}[H]
 \centering
 \includegraphics[width=\textwidth]{./images/Input-Messages4.PNG}
 % Input-Messages4.PNG: 0x0 pixel, 0dpi, nanxnan cm, bb=
 \caption{Structure of the Manage\_TrackSideInformation\_Integration module with submodules}
 \label{fig:receiveAndCheckConsistencyArch}
\end{figure}


\subsubsection{Input}
For providing the output, the module needs different input data flows. An overview is provided in table \ref{tbl:ReceiveMessageAndCheckConsistencyInput}

\begin{minipage}{\linewidth}
  \scriptsize
  \begin{tabular}{| c | l | l | l | l |}
    \hline
    \textbf{Index} & \textbf{Input name} & \textbf{Input type} & \textbf{Source}\\ \hline
    0 & \texttt{fullChecks} & \texttt{bool} & Configuration \\
    1 & \texttt{API\_trackSide\_Message} & \texttt{API\_Msg\_Pkg::API\_TrackSideInput\_T} & API\\
    2 & \texttt{ActualOdometry} & \texttt{Obu\_BasicTypes\_Pkg::odometry\_T} & Odometer\\
    3 & \texttt{reset} & \texttt{bool} & Environment\\
    4 & \texttt{trainPosition} & \texttt{TrainPosition\_Types\_Pck::trainPosition\_T} & Calculate Train Position\\
    5 & \texttt{modeAndLevel} & \texttt{BG\_Types\_Pkg::ModeAndLevelStatus\_T} & Mode and Level\\
    6 & \texttt{tNvContact} & \texttt{Obu\_BasicTypes\_Pkg::T\_internal\_Type} & Database\\
    7 & \texttt{lastRelevantEventTimestamp} & \texttt{Obu\_BasicTypes\_Pkg::T\_internal\_Type} & Database\\
    8 & \texttt{connectionStatus} & \texttt{Radio\_Types\_Pkg::sessionStatus\_Type} & Manage Radio Communication\\
    9 & \texttt{inSupervisingRbcId} & \texttt{int} & Database\\
    10 & \texttt{inAnnouncedBGs} & \texttt{TrainPosition\_Types\_Pck::positionedBGs\_T} & Calculate Train Position\\
    11 & \texttt{q\_nvlocacc} & \texttt{Q\_NVLOCACC} & Database\\
    \hline
  \end{tabular} 
  \captionof{table}{Overview over input}
  \label{tbl:ReceiveMessageAndCheckConsistencyInput}
\end{minipage}

\paragraph{Input 0: \texttt{fullChecks\\}}
The boolean indicates, if all checks on the message should be performed. The possible values are given in table \ref{tbl:fullChecks}.

\begin{minipage}{\linewidth}
 \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & All checks are performed.\\
    false & The module \texttt{Information Filter} is deactivated.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{fullChecks}}
  \label{tbl:fullChecks}
\end{minipage}

\paragraph{Input 1: \texttt{API\_trackSide\_Message}}

The \texttt{API\_trackSide\_Message} is the message received from the API. The API performs preprocessing of RTM and BTM messages and deliveres a maximum of a single message per cycle to the SCADE model.

\paragraph{Input 2: \texttt{ActualOdometry}}
The input \texttt{ActualOdometry} is provided by the external odometry module of the train. It contains location information with inaccuracies.

\paragraph{Input 3: \texttt{reset}\\}
To delete all data stored in the module (e.g. collected balise-telegrams, which do not yet form a complete message), a reset input can be used. If the input is set to \texttt{true}, all data kept in the module is deleted and no input is accepted.

\begin{minipage}{\linewidth}
   \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & All data kept in the module is deleted and no input is accepted.\\
    false & No action. Data at input is accepted.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{reset}}
  \label{tbl:reset}
\end{minipage}


\paragraph{Input 4: \texttt{trainPosition}}
The input \texttt{trainPosition} is generated by the ``Calculate Train Position'' module and contains the current position of the train.

\paragraph{Input 5: \texttt{modeAndLevel}}
The input is generated by the ``Mode and level management'' module. It provides the current level and mode of the EVC.

\paragraph{Input 6: \texttt{tNvContact}}

For monitoring the safe radio connection, the national value \texttt{T\_NVCONTACT} is needed as an input.

\paragraph{Input 7: \texttt{lastRelevantEventTimestamp}}

For monitoring the safe radio connection, it's necessary, that the time between two packets is less than the value of \texttt{T\_NVCONTACT}.

In situations like level-changes or announced radioholes, not the timestamp of the last message is relevant for comparison, but the timestamp of the last relevant event. This can be e.g. the timestamp of the level change or the timestamp of the timestamp of the moment, when the train was passing the end of the radiohole. 

For performing this check, the timestamp of the last relevant event is provided to the model as an \texttt{T\_internal\_Type}-type.

\paragraph{Input 8: \texttt{connectionStatus}\\}
The input \texttt{connectionStatus} will give information about the radio connection. This input is delivered by the session management module, not from the API. The information is needed to perform the timing check, which is depending on the connection state.

\begin{minipage}{\linewidth}
  \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    DISCONNECTED & The OBU is currently not connected to a RBC.\\
    CONNECTING & The OBU is currently connecting to the RBC. Received messages belong to the process of establishing a connection.\\
    CONNECTION\_ESTABLISHED &  The connection to RBC is established.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{connectionStatus}}
  \label{tbl:connectionStatus}
\end{minipage}

\paragraph{Input 9: \texttt{inSupervisingRbcId}}
For the submodule ``Information Filter'', the information is needed, which radio messages are sent by the supervising RBC. To recognize these messages, the identifier of the supervising RBC is needed.

\paragraph{Input 10: \texttt{inAnnouncedBGs}}
This input provides information about balise groups which will be passed by the train soon. This information is generated by ``Calculate Train Position'' based on the linking information received from trackside.

\paragraph{Input 11: \texttt{q\_nvlocacc}}
The national value determines the location accuracy and is delivered by the database.



\subsubsection{Output}
The output of the module provides the received and processed Euroradio and Eurobalise messages. The module combines messages both from Eurobalises and from Euroradio to one common dataflow.

An overview over the output dataflows is provided in table \ref{tbl:ReceiveMessageAndCheckConsistencyOutput}.

\begin{minipage}{\linewidth}
 \footnotesize
  \begin{tabular}{| c | l | l | l |}
    \hline
    \textbf{Index} & \textbf{Output name} & \textbf{Output type}\\ \hline
    0 & \texttt{outputMessage} & \texttt{Common\_Types\_Pkg::ReceivedMessage\_T}\\
    1 & \texttt{ApplyServiceBrake} & \texttt{bool}\\
    2 & \texttt{BadBAliseMessageToDMI} & \texttt{bool}\\
    3 & \texttt{errorLinkedBG} & \texttt{bool}\\
    4 & \texttt{errorUnlinkedBG} & \texttt{bool}\\
    5 & \texttt{passedBG} & \texttt{BG\_Types\_Pkg::passedBG\_T} \\
    6 & \texttt{outPositionParams} & \texttt{Common\_Types\_Pkg::PositionReportParameter\_T} \\
    7 & \texttt{outRadioManagement} & \texttt{Common\_Types\_Pkg::radioManagementMessage\_T} \\
    8 & \texttt{radioSequenceError} & \texttt{bool} \\
    9 & \texttt{radioMessageConsistencyError} & \texttt{bool} \\
    \hline
  \end{tabular} 
  \captionof{table}{Dataflow at output}
  \label{tbl:ReceiveMessageAndCheckConsistencyOutput}
\end{minipage}

\subparagraph{Output 0: \texttt{outputMessage}\\}
The element \texttt{outputMessage} consists of the type \texttt{ReceivedMessage\_T} combines both balise and radio messages to one common datatype. This datatype contains all variables and packets, which are possible for the given scenario.

\begin{minipage}{\linewidth}
  \scriptsize
  \begin{tabular}{| l | l | p{5.5cm} |}
  \hline
  \textbf{Name} & \textbf{Datatype} & \textbf{Description}\\ \hline
  \texttt{valid} & \texttt{bool} & true, if no consistency errors were detected.\\
  \texttt{source} & \texttt{Common\_Types\_Pkg::MsgSource\_T} & Defines, if this is a Euroradio or Eurobalise message.\\
  \texttt{packetMetadata} & \texttt{Common\_Types\_Pkg::Metadata\_T} & contains the metadata of the packets\\
  \texttt{radioMetadata} & \texttt{Common\_Types\_Pkg::RadioMetadata\_T} & contains the metadata of the radio specific header variables\\
  \texttt{BG\_Common\_Header} & \texttt{BG\_Types\_Pkg::BG\_Header\_T} & Header of Eurobalise message\\
  \texttt{Radio\_Common\_Header} & \texttt{Radio\_Types\_Pkg::Radio\_TrackTrain\_Header\_T} & Header of Euroradio message\\
  \texttt{packets} & Common\_Types\_Pkg::Packets\_T & Structure of packets in messages\\
  \hline
\end{tabular}
  \captionof{table}{Structure of \texttt{ReceivedMessage\_T}}
  \label{tbl:receivedMessage_structure}
\end{minipage}


The Eurobalise-common-header \texttt{BG\_Header\_T} consists of the fields visible in the SCADE-declaration. The structure corresponds to the structure defined in the SRS chapter 8.4.2.1. Some fields were removed since they are not needed anymore for further processing after building messages from separate telegrams.

The Euroradio-common-header \texttt{Radio\_TrackTrain\_Header\_T} consists of the fields visible in the SCADE declaration. The structure corresponds to the structure defined in the SRS chapter 8.4.4.6.1. The structure contains all variables required by possible \texttt{NID\_MESSAGE} values for the given scenario. Which values are valid is defined in the field \texttt{radioMetadata}.

%\textbf{TODO:} Different definition of Radio-header than in SCADE!

%\textbf{TODO:} Note on packet type definitions and implementation details (which values were not used).

%\textbf{Note:} Packet 44 not used (applications outside the ERTMS/ETCS system are not supported by this implementation).

%\textbf{TODO:} Define packets 136, 12 in SCADE.

\subparagraph{Output 1: \texttt{ApplyServiceBreak}}
The flag indicates the balise group the train just passed could not be processed correctly. The check results in the request for a service break.

\subparagraph{Output 2: \texttt{BadBaliseMessageToDMI}}
Information to be passed to the DMI to indicate the reception of a ``bad balise'' to the driver.

\subparagraph{Output 3: \texttt{errorLinkedBG}\\}

\begin{minipage}{\linewidth}
  \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & A error in a linked balise group was detected.\\
    false & No error in a linked balise group was detected.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{errorLinkedBG}}
  \label{tbl:errorLinkedBG}
\end{minipage}

\subparagraph{Output 4: \texttt{errorUnlinkedBG}\\}
\begin{minipage}{\linewidth}
  \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & A error in an unlinked balise group was detected.\\
    false & No error in an unlinked balise group was detected.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{errorUnlinkedBG}}
  \label{tbl:errorUnlinkedBG}
\end{minipage}

\subparagraph{Output 5: \texttt{passedBG}}
The output \texttt{passedBG} provides the received balise group message in a special format needed by the module ``Calculate train position''.

\subparagraph{Output 6: \texttt{outPositionParams}}
The output \texttt{outPositionParams} provides the parameters for the position report in a special format needed by the module ``Provide Position Report''.

\subparagraph{Output 7: \texttt{outRadioManagement}}
The output \texttt{outRadioManagement} provides the messages for radio session management in a special format needed by the module ``Management of Radio Communication''.

\subparagraph{Output 8: \texttt{radioSequenceError\\}}

\begin{minipage}{\linewidth}
  \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & A sequence error or a timeout has been detected in the radio message.\\
    false & No error in the radio message sequence was detected.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{radioSequenceError}}
  \label{tbl:radioSequenceError}
\end{minipage}

\subparagraph{Output 9: \texttt{radioMessageConsistencyError\\}}

\begin{minipage}{\linewidth}
  \begin{tabular}{| l | p{9cm} |}
    \hline
    \textbf{Value} & \textbf{Interpretation}\\ \hline
    true & A consistency error has been detected in the radio message.\\
    false & No consistency error in the radio message was detected.\\
    \hline
  \end{tabular} 
  \captionof{table}{Possible values for the input \texttt{radioMessageConsistencyError}}
  \label{tbl:radioMessageConsistencyError}
\end{minipage} 

~\\

\subsubsection{Receive\_TrackSide\_Msg in Manage\_TrackSideInformation\_Integration}

\paragraph{Reference to the SRS (or other requirements)}
\begin{itemize}
  \item \cite[Chapt.~7 and 8]{subset-026}: Definition of the Balise Telegram
  \item \cite[Chapt.~4.2.2, 4.2.4, 4.2.9]{subset-036}: Interface to the BTM
  \item \cite[Chapt.~3.4.1 - 3.4.3, 3.16.2]{subset-026}: Handling of Balise Telegrams
  \item \cite[Chapt.~3.16.2]{subset-026}: Check of the balise group
  \item \cite[Chapt.~3.4.2]{subset-026}: Determining the orientation
  \item \cite[Chapt.~4.5.2]{subset-026}: Active Functions Table
  \item \cite[Chapt.~8.4.4]{subset-026}: Rules for Euroradio messages

\end{itemize}
\paragraph{Short description of the functionality}
This function defines the interface of the OBU model to the openETCS generic API for Eurobalise  and Euroradio messages. On the interface, either a valid telegram/message is provided or a telegram/message is indicated which could not be received correct when passing the balise or receiving the radio message. The function passes a balise telegram without major changes of the information to the next entity for collecting the balise group information. This entity collects telegrams received via the interface into Balise Group Information. In case of a radio message, the message is converted to an internal format for further processing and passed without changing the information contained.

\paragraph{Interface}
\paragraph{Functional Design Description}
\textbf{Design Constraints and Choices}
\begin{enumerate}
\item The decoding of balises is done at the API. Also, packets received via the interface are already transformed into a usable shape.
\item Only packets used inside the current model are passed via the interface.\\
\item Treatment of Packet 5: Linking Information.\\
Linking Information is added to the linking array starting from index 0 without gaps. Used elements are marked as valid. Elements are sorted according to the order given by the telegram sequence.
\item Telegrams received as invalid are passed to the ``Check-Function'' to process errors in communication with the track side according to the requirements and in a single place.
Telegrams are added to the telegram array starting from index 0 without gaps. Used elements are marked as valid. Elements are stored according to the order given by the telegram sequence.
\item This function does not process information from the packets. The information is passed to the check without further processing of the values. 
\end{enumerate}
\paragraph{Reference to the Scade Model}
The SCADE model can be found on github under the following path:

\tiny\url{https://github.com/openETCS/modeling/tree/master/model/Scade/System/ObuFunctions/ManageLocationRelatedInformation/BaliseGroup/Receive_TrackSide_Msg}
\normalsize
\subsubsection{CheckBGConsistency in Manage\_TrackSideInformation\_Integration}%Mainfunction receive track data. Name should be be defined and substituded by the designer of the function. 
\paragraph{Reference to the SRS or other Requirements (or other requirements)}
\begin{itemize}
  \item \cite[Chapt.~7 and 8]{subset-026}: Definition of the Balise Telegram
  \item \cite[Chapt.~3.4.1 - 3.4.3, 3.16.2]{subset-026}: Handling of Balise Telegrams
  \item \cite[Chapt.~3.16.2]{subset-026}: Check of the balise group
  \item \cite[Chapt.~4.5.2]{subset-026}: Active Functions Table
\end{itemize}
\paragraph{Short description of the functionality}
This function has the task  to verify the completeness and correctness of the received messages from balise groups.\\
A message consists of at least a telegram and a maximum of 8 telegrams.\\

\begin{itemize}
\item A message is still complete and correct, if a telegram is missing (or not decoded or incomplete decoded ), and this telegram is duplicated within the balise group and the duplicating one is correctly read.
\item By more than one telegram, the order of the telegrams must be either ascending (nominal) or descending(reverse).\\
\item A message is correct, if  all message counters (M MCUNT) do not equal 254 (that means: The telegram never fits any message of the group).\\ A message counter can be equal 255 (that means: The telegram fits with all telegrams of the same balise group) and all other values must be the same.\\
\end{itemize}

\paragraph{Interface}

\paragraph{Functional Design Description}
This function is active in certain modes and the output and reactions are dependent on if the linking information is used.\\
The orientation of the BG will also be calculated in this block.\
The check, if the message has been received in due time and the right at the right expected location, will be performed in "Calculate Train Position".\\
The checks on the validity of the data in the packets and the validity with respect to the direction of motion will be performed in other modules, e.g. "Validate Data Direction" .

\paragraph{Reference to the Scade Model}
The SCADE model can be found on github under the following path:

\tiny\url{https://github.com/openETCS/modeling/tree/master/model/Scade/System/ObuFunctions/ManageLocationRelatedInformation/BaliseGroup/CheckBGConsistency}
\normalsize

\subsubsection{CheckEuroradioMessage in Manage\_TrackSideInformation\_Integration}%Mainfunction receive track data. Name should be be defined and substituded by the designer of the function. 
\paragraph{Reference to the SRS or other Requirements (or other requirements)}
\begin{itemize}
 \item \cite[Chapt.~8.4.4]{subset-026}: Rules for Euroradio messages
 \item \cite[Chapt.~3.16]{subset-026}: Data consistency
\end{itemize}
\paragraph{Short description of the functionality}

The operator ``CheckEuroradioMessage'' performs several checks on the received radio message. These checks include checking of the message sequence, completeness of messages. Invalid messages are marked as invalid in the message header.

\paragraph{Interface}
The operator expects a radio message, information about the timestamp of the last relevant event, the national value for timeout (\texttt{T\_NVCONTACT}) and the status of the radio connection as input. The operator provides as output the radio message marked as valid or invalid in the message header and updated metadata in the message. Errors are indicated through boolean outputs.

\paragraph{Functional Design Description}

The operator performs the following checks:
\begin{itemize}
 \item Content checks
 \begin{itemize}
    %\item The computed length of the message must be equal to the value in \texttt{L\_MESSAGE}. (SRS 8.4.4.2.1)
    \item The whole message must be complete and contains all necessary fields. \cite[3.16.1.1]{subset-026}
    \item The message must respect the ETCS language. \cite[3.16.1.1]{subset-026} The operator checks, if all necessary variables and packets for the corresponding message are part of the message and if no packets and variables are included in the message, which are not allowed.
    %\item The variables of the message do not contain invalid values. \cite[3.16.1.1]{subset-026} % already done by API?
    %\item Check if the specified priority of message is equal to the priority with which the message was received. \cite[3.16.3.1.3.1]{subset-026}
  \end{itemize}
  \item Timing checks
  \begin{itemize}
    \item Check if the timestamp of a message is greater than the timestamp of the message received before. \cite[3.16.3.3.3]{subset-026}
    \item If a message contains the timestamp ``Unknown'', check if this message is part of the initiation of the communication session. \cite[3.16.3.3.4]{subset-026}
    \item Perform the check with the current message $n$:  $T\_TRAIN_{n} <= T\_TRAIN_{n-1} + T\_NVCONTACT$ \cite[3.16.1.1]{subset-026}. This ensures, that the message was received in due time.
  \end{itemize}
\end{itemize}

For inconsistent messages, the following actions are performed by the operator:

\begin{itemize}
  \item If a message is not consistent, it shall be rejected. \cite[3.16.3.1.1.1]{subset-026} For this purpose, the message is marked as invalid, so it can be rejected by the operators using the output of the CheckEuroradioMessage-operator.
  \item The RBC shall be informed, when a message was rejected. \cite[3.16.3.1.1.2]{subset-026} Therefore the necessary information for creating an error report is provided as boolean flags. 
  %\item If the RBC requested an ACK for a received message, message will be marked for the module to send a report to the RBC. (SRS 3.16.3.5)
  \item This operator will not trigger the reaction for an interrupted radio connection to the RBC. The reaction sepcified by \texttt{M\_NVCONTACT} will be triggered by the RBC session management module.
\end{itemize}

The check by the Euroradio-protocol \cite[3.16.3.1.1]{subset-026} will not be performed by the operator, but on a lower level (RTM or openETCS-API).

The operator is not responsible for checking the integrity of the message in the bitstream format. The bitwalker, which is converting the bitstream into the internally used datatypes, is performing the checks, which are only possible on the raw data. This includes a CRC check on the whole message and a value range check for each variable. If a consistency error is detected by the bitwalker, it is signalled to the model. If the bitwalker marks a packet as valid, all variables are expected to contain a valid value. The bitwalker is not part of the ETCS kernel.

Safe connection supervision is not in the scope of this operator. This functionality will be implemented by the ``Management of Radio communication'' module.

\paragraph{Reference to the Scade Model}
The SCADE model can be found on github under the following path:

\tiny\url{https://github.com/openETCS/modeling/tree/master/model/Scade/System/ObuFunctions/ManageLocationRelatedInformation/BaliseGroup/CheckEuroRadioMessage}
\normalsize

\subsubsection{ValidateDataDirection in Manage\_TrackSideInformation\_Integration}

\paragraph{Reference to the SRS or other Requirements (or other requirements)}
\begin{itemize}
 \item The functionality is mainly described in \cite[Chapter~3.6.3]{subset-026}.
\end{itemize}
\paragraph{Short description of the functionality}
The operator will filter an input message in order to mark all elements as invalid, which are not designated for the current driving direction of the train.

\paragraph{Interface}
The operator expects a message and information about the LRBG, passed balises and the current train position. As output, the message with packets valid for the current direction of driving is provided.
\paragraph{Functional Design Description}
\begin{itemize}
 \item The operator contains two processing paths for different message types. Radio messages and balise group messages are handeled in a different way. For validating the data direction of a radio message, the check is performed using the balise group referenced in the radio message header as relevant balise group. For balise group message, the LRBG is used.
 \item The metadata of packets, which are recognized as not valid for the current driving direction, is invalidated.
\end{itemize}

\paragraph{Reference to the Scade Model}
The SCADE model can be found on github under the following path:

\tiny\url{https://github.com/openETCS/modeling/tree/master/model/Scade/System/ObuFunctions/ManageLocationRelatedInformation/BaliseGroup/ValidateDataDirection}
\normalsize

\subsubsection{InformationFilter in Manage\_TrackSideInformation\_Integration}%Mainfunction Train Supervision. Name should be be defined and substituded by the designer of the function. 
\paragraph{Reference to the SRS or other Requirements (or other requirements)}
\begin{itemize}
 \item The functionality of Select Usable Info is described in Chapter 4.8 of subset-026 \cite{subset-026}. The following list gives an overview of the most important sections for each of the blocks in the model.
 \item § 4.8.2, § 4.8.2, § 4.8.3, § 4.8.4
\end{itemize}

\paragraph{Short description of the functionality}
The function Select Usable Info filters information received from balises that have been passed, radio messages, and EUROLOOP messages. Filtering is done depending on the mode of the train, the current ETCS level, the type/content of the information, and the transition media of the information. As neither radio messages nor EUROLOOP are part of the first iteration of work, not all functionality of the filter described in the specification is currently implemented.
\paragraph{Interface}
\textbf{Input from:} Receive MSG Check Consistency/Coordinate System - track messages and package\\
Level and Mode Management - Mode and Level State\\

\textbf{Output to:} Build Data structure and Location Based/ Build Data Structures Drivers- forwarded packages, messages and variables\\

\begin{figure}[hbtp]
\centering
\includegraphics[scale=0.7]{images/FilterInandOUt}
\caption{Filter In and out}
\end{figure}

\subsubsection{SysML Model}
\begin{figure}[hbtp]
\centering
\includegraphics [scale=0.5]{images/SysMLFilter}
\caption{SysML Filter}
\end{figure}

\paragraph{Functional Design Description}
The fillter receives track information (balise an radio) and will filter them in dependency of the mode and level.
Therefore the filter needs the input from level and mode management. The filtered information will be forwarded to the data strcuture.

\begin{description}
\item[First filter] The first filter, i.e.~the filter on the level, is described in \cite[Chapter~4.8.3]{subset-026}.
\item[Second filter] The second filter, i.e.~the filter on the transition media, is described in\cite[Chapter~4.8.3]{subset-026}.
\item[Third filter]
 The third filter, i.e.~the filter on the modes, is described in \cite[Chapter~4.8.4]{subset-026}.
\item[Transition buffers] Details on the handling of the transition buffers used in the first and the second filter are described in \cite[Chapter~4.8.5]{subset-026}.
\end{description}

%%%% 
\subparagraph{Documentation of design}
From § 4.8.1.2 The following sections have to be interpreted by applying the filters and the assigned packets/messages as shown in Figure a and 2. The first filter is detailed in section § 4.8.3 (figure 1) “Accepted information depending on the level and transmission media”, the third filter in section § 4.8.4 (figure 2) “Accepted information depending on the modes”.\\

From § 4.8.1.3 If a message contains level transition information, any other information in that message shall be evaluated considering the level transition information. Explanation: If a message contains level transition information, all other information in that message shall be buffered and level transition shall be read first. Then the remained balise information shall be read from the buffer in the level that was announced to the balise.\\

From § 4.8.1.3.1 Information received in the same message as an immediate level transition order or a conditional level transition order that causes a level transition shall be evaluated first considering the on-board currently operated level, as if a level transition order for further location had been received (i.e. conditions [1], [2] or [6] of Figure 1, if applied, shall be automatically fulfilled). Then, if relevant, it shall be immediately extracted from the buffer and re-evaluated according to the new selected level.\\
\textbf{Explanation:} As described in Explanation of § 4.8.1.3 and figure 1 – First Filter conditions [1], [2] and [6])\\

From § 4.8.1.4 Note: As shown in Figure 1, information stored following an announcement of a change of level, is re-checked for acceptance when the level has changed. This implies that, when the level changes, the mode is - for a short moment – still unchanged, until the stored information has been processed. The consequence for the Third Filter is that information needs to be accepted for this short period also in modes in which this information is otherwise useless.\\
\textbf{Explanation:} when a level announced the level the mode change will be unchanged until the buffered information has been processed. The model change is the third filter (§ 4.8.3 figure 3).\\

\subparagraph{table for the filter rules}
\textbf{Assumptions from § 4.8.2 need to be considered}\\
\textbf{Explanation}: See figure 1 and 2 – announced packets/messages/variables to the filter. Exception and explanation of the meaning of R and A please read § 4.8.3.\\. 

\textbf {Filter rules}: Filter will filter messages, packages and variables. Therefole a rule must be defined to cover all these inputs.\\

\textbf {Explanation figure 1}: will filtering the different inputs in dependency of the level\\
\textbf {Explanation figure 2}: will filtering the different inputs in dependency of thel mode\\

\subparagraph{Filter on Level}
\begin{figure}[hbtp]
\centering
\includegraphics [scale=0.6]{images/LevelFilter1}
\end{figure}
\begin{figure}[hbtp]
\centering
\includegraphics [scale=0.6]{images/LevelFilter2}
\end{figure}
\begin{figure}[hbtp]
\centering
\includegraphics [scale=0.6]{images/LevelFilter3}
\end{figure}
\begin{figure}[hbtp]
\centering
\includegraphics [scale=0.6]{images/LevelFilter4}
\caption{Level Filter}
\end{figure}
\newpage

\subparagraph{Filter on Modes}
\begin{figure}[hbtp]
\centering
\includegraphics [angle=90, scale=0.8]{images/FilterMode1}
\end{figure}
\begin{figure}[hbtp]
\centering
\includegraphics [angle=90, scale=0.8]{images/FilterMode2}
\end{figure}
\begin{figure}[hbtp]
\centering
\caption{Mode Filter}
\end{figure}
\newpage

\subparagraph{Filtering (Mode/Level) - One packet per type}
\textbf{ISSUE: HOW MANY PKT 44, 65 AND 66 PER MESSAGE ARE MAXIMALLY SUPPORTED? (BH: who made this comment??)}\\

- Check on announced and immediate level transition orders in the messages to be filtered (needed for further criteria for filtering, to decide if the data shall be stored in the transition buffer).\\
- Filter data stored in the transition buffer according to the current level (what to do if similar information is available in the new message??). Data can be rejected, accepted or kept in the transition buffer.
(Filtering according to new level will be done directly afterwards in the next cycle)\\
- Filter new received messages according to the current level (new level will be done in the next cycle as according to \gls{SRS} data first has to be filtered according to old level and afterwards to new level). Data can be rejected, accepted or stored in the transition buffer.\\
- Filter (level) accepted data according to originating RBC (supervising or other). Information from \gls{BG}'s, loops or RIU is not filtered with this filter.\\
- Filter (level and RBC) accepted data according to the current mode (only reject or accept)\\
\paragraph{Reference to the Scade Model}
The SCADE model can be found on github under the following path:

\tiny\url{https://github.com/openETCS/modeling/tree/master/model/Scade/System/ObuFunctions/ManageLocationRelatedInformation/BaliseGroup/InformationFilter}
\normalsize