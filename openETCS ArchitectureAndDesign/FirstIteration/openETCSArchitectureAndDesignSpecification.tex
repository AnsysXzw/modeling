\documentclass{template/openetcs_report}
% Use the option "nocc" if the document is not licensed under Creative Commons
%\documentclass[nocc]{template/openetcs_article}
\usepackage{lipsum,url}
\usepackage{supertabular}
\usepackage{multirow}
\usepackage{color, colortbl}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{makeidx}
\definecolor{gray}{rgb}{0.8,0.8,0.8}
\usepackage[modulo]{lineno}
\graphicspath{{./template/}{.}{./images/}}
\begin{document}
\frontmatter
\project{openETCS}

\newcommand{\define}[1]{\index{#1}\emph{#1}}

%Please do not change anything above this line
%============================

%user specified macros
%\input{sections/macros.tex}

% The document metadata is defined below

%assign a report number here
\reportnum{OETCS/WP3/D3.5.1.1}

%define your workpackage here
\wp{Work-Package 3: ``Modeling''}

%set a title here
\title{openETCS System Architecture and Design Specification}

%set a subtitle here
\subtitle{First Iteration: ETCS Kernel Functions}

%set the date of the report here
\date{October 2014}


%document approval
%define the name and affiliation of the people involved in the documents approbation here
\creatorname{Bernd Hekele}
\creatoraffil{DB-Netz}

\techassessorname{[assessor name]}
\techassessoraffil{[affiliation]}

\qualityassessorname{Izaskun de la Torre}
\qualityassessoraffil{SQS}

\approvalname{Klaus-R\"udiger Hase}
\approvalaffil{DB Netz}


%define a list of authors and their affiliation here

\author{Bernd Hekele, Peter Mahlmann, Peyman Farhangi}

\affiliation{DB-Netz AG\\
  V\"olckerstrasse 5\\
  D-80959 M\"unchen Freimann, Germany}

\author{Uwe Steinke}

\affiliation{Siemens AG}

\author{Christian Stahl}

\affiliation{TWT-GmbH}

\author{David Mentr√©}
\affiliation{Mitsubishi Electric R\&D Centre Europe}

% define the coverart
\coverart[width=350pt]{openETCS_EUPL}

%define the type of report
\reporttype{Architecture and Design Specification}


\begin{abstract}
%define an abstract here
This document gives an introduction to the architecture of the first openETCS iteration, the openETCS kernel functions. It has to be read as an add-on to the models in SysML, Scade and to additional reading referenced from the document.
\end{abstract}

%=============================
\maketitle

%Modification history
%if you do not need a modification history table for your document simply comment out the eight lines below
%=============================


\section*{Modification History}
\tablefirsthead{
\hline 
\rowcolor{gray} 
Version & Section & Modification / Description & Author \\\hline}
\begin{supertabular}{| m{1.2cm} | m{1.2cm} | m{6.6cm} | m{4cm} |}
%\begin{supertabular}{| c | c | l | l |}
0.1 & all & Initial document providing the structure & Bernd Hekele \\\hline
0.2 & \ref{sss:provposrep} & initial contribution and some pretty printing & Christian Stahl \\\hline
0.3 & all & collecting feedback and completion on initial sections & Bernd Hekele \\\hline
0.4 & all & changed document style to openETCS report improved pretty printing & Peter Mahlmann \\\hline
0.4.1 & all & adding content & Bernd Hekele \\\hline
\end{supertabular}

% list subsubsections in table of contents
\setcounter{tocdepth}{3}

\tableofcontents
\listoffiguresandtables
\newpage
%=============================

%Uncomment the next line if you need line numbers for tracebility when the document is in review
%\linenumbers
%=============================


% The actual document starts below this line
%=============================
\mainmatter

\chapter{Introduction}


\section{Motivation}
\label{sec:Motivation}

The openETCS work package WP3 aims to provide the architecture and the design of the openETCS OBU software as mainly specified in UNISIG Subset\_026 version\_3.3.0 \cite{subset-026}. 

The appropriate functionality has been divided into a list of functions of different complexity (see the WP3 function list \cite{functions}).

All these functions are object of the openETCS project and have to be analysed from their requirements and subsequently modelled and implemented. With limited manpower, a reasonable selection and order of these functions is required for the practical work that allows the distribution of the workload, more openETCS participants to join and leads to an executable---limited---kernel function as soon as possible. 

While the first version of this document focuses on the first version of the limited kernel function, it is intended to grow in parallel to the growing openETCS software.


\section{Objectives}
\label{sec:Objectives}



The first objective of WP3 software shall be
\begin{itemize}
	\item ``Make the train run as soon as possible, with a very minimum functionality, and in the form of a rapid prototype.''
\end{itemize}
This does not contradict the openETCS goal to conform to EN50128.
\begin{itemize}
	\item After a phase of prototyping, the openETCS software shall be implemented in compliance to EN50128 for SIL4 systems.
\end{itemize}
Additional goals for this document are
\begin{itemize}
	\item Identification of the functions required for a minimum OBU kernel,
	\item Architecture overview regarding the minimum OBU kernel,
	\item Technical approach: Description of the proceeding and methods to be used,
	\item Road map of the minimum OBU kernel functions, and
	\item Road map thereafter
\end{itemize}

Note: This document will be extended according to the progress of WP3. 


\section{History}

%-----------------------------------------------------------------------
\section{Goals of the openETCS Modelling Work}
%-----------------------------------------------------------------------
%\tbc
%by Uwe


\subsection{Functional Scope: The Minimum OBU Kernel Function}
\label{sec:FunctionalScopeTheMinimumOBUKernelFunction}

The objective ``Make the train run with a very minimum functionality'' (see Chapter~\ref{sec:Objectives}) shall be in terms of ETCS OBU translated into 
\begin{itemize}
	\item ``The Train moves on a track equipped with balises and determines its position.''
\end{itemize}
That means, for this very first step, the train shall neither supervise the maximum speed nor activate the brakes. The minimum function set shall be limited to:
\begin{itemize}
	\item Receive, filter and manage balise information received from track (see \url{https://github.com/openETCS/SRS-Analysis/issues/12});
	\item Calculate the actual train position based on balise and odometry information (see \url{https://github.com/openETCS/SRS-Analysis/issues/8});
	\item Calculate the distances between the actual train position to track elements in its front.
\end{itemize}
The activities of the first iteration are collected in the openETCS WP3 backlog for the first iteration \cite{firstIteration}.

A more detailed architectural breakdown of these functions is available as a SysML model \cite{sysml-model}. Diagrams used in the document at hand describing the architecture are taken from the model in \cite{sysml-model}.

The design is implemented in the Scade Model \cite{scade-model}. Design documents are taken from this model. Design diagrams used in this document are generated from the model. The design documents produced from the scade model are provided in the design location on Github \cite{designFI}.

In addition, the work on this minimum functionality requires to be supported by
\begin{itemize}
	\item The availability of the ETCS language as specified in Subset UNISIG Subset\_026, chapters 7 and 8;
	\item The abiltiy to link intermediate and final results with the requirements of the ETCS specification (subset\_026, etc.). 
\end{itemize}
These supporting prerequisites are under construction and therefore currently not completely operable. How to deal with these restrictions, will be outlined in Chapter~\ref{}.

\section{Glossary and Abbreviations}

\textbf{API} Application Programming Interface\\
\textbf{EVC} European Vital Computer\\
\textbf{BTM} Balise Transmission Module\\
\textbf{SRS} System Requirements Specification\\




%==================================================================

\chapter{The openETCS Architecture of the Initial Kernel Functions}

\section{The openETCS Tool Chain and its Impacts on the Actual Model}

For understanding the modelling process and the modeling guidelines, we refer to \cite{wp3-dow}. 

To summarize the design process, the following rules are in use:
\begin{itemize}
\item Papyrus / SysML is used for modelling the architecture. Functions are visible on this SysML level.
\item No behaviour model is allowed on SysML level.
\item For referencing the requirements, links from the SysML model to the requirements document (in ProR) are being used.
\item Details and especially behaviour is modelled in Scade.
\item All interfaces (see also data-dictionary below) are available on bit-level.
\item In the architecture model in SysML, all interfaces are available on a functional level for interfaces inside and outside the model and for interfaces between dedicated functions. Due to tool constrains the current model does not show all details for all interfaces (see the data dictionary \cite{dataDictionary}).
\end{itemize}

The openETCS tool-chain for doing the modelling work consists of the following components:
\begin{description}
	\item[Papyrus] for modelling the architecture (Kepler version).
	In this phase only the Kepler version of the tool can be used due to incompatibilities of the Kepler and the Luna version on the SysML model. The SysML models are stored at \url{https://github.com/openETCS/modeling/tree/master/model/sysml}.
	\item[ProR] for keeping the requirements (REQIF).
	The subset 26 is converted into a REQIF-format and also stored in the modeling repository on Github. The openETCS toolchain supports the linking of SysML model parts to SRS-Requirements. These results are also part of the architecture.
	\item[Scade] for designing and formalising the functions Scade version 15.2 is used.
	The models are stored at \url{https://github.com/openETCS/modeling/tree/master/model/Scade}.
	With the component Scade System Scade also has a component for designing the architecture.
\end{description}

In principle, the synchronisation mechanism of Scade was planned to be used for synchronising the SysML architecture and the Scade models. The idea is to automatically synchronise the SysML types and blocks with the Scade type definitions and the Scade Operators. Unfortunately, with the current set of tools this idea cannot be realised. We will investigate other tools and models to find a solution. 

In addition, faults in the Kepler Papyrus version made it difficult for several members of the team to work on different submodels of the openETCS model. The issue will be solved when changing to the Luna version of Papyrus.

\section{The openETCS Application Software Architecture}


The following diagrams are taken from the SysML model \cite{sysml-model}.

\begin{figure}[h]
\centering
\includegraphics[scale=0.6]{../images/FunctionalArchitectureBDD.png}
\caption{Block Definition Diagram of the First Iteration Architecture}
\end{figure}

The diagram shows the hierarchy of the EVC model. The boundaries of the model are given with the API (interfaces into and outside the EVC model), which actually is not part of the diagram. The runtime system of the EVC is also seen as a part outside the model.

\begin{figure}[p]
\centering
\includegraphics[scale=0.2]{../images/ManageLocationInformationIBD.png}
\caption{Internal Block Diagram of the First Iteration Architecture}
\end{figure}

Green blocks in this diagram are seen as data collected by the ``train'' without making use of the function in focus.

Input to the model is via the API\marginpar{The interface of the model is defined by the API?}. The border\marginpar{of what?} is inside the EVC Scade model. 

\section{openETCS Data Dictionary}
In the first iteration, the openETCS data dictionary gives some basic constructs for the project, the definition of interfaces in a central place and the definition of the ETCS language \cite{dataDictionary}.

\subsection{ETCS Language}
The type definitions of Subset 26 chapters 7 and 8 (called the ETCS language) are provided as SysML resp. Scade types to the openETCS model. For the SysML model the types have been generated based on tools and provided as <>package<> imported to the openETCS toolschain.



\subsection{openETCS Interfaces}
Interfaces used between submodels and interfaces from outside and to outside the EVC kernel are defined as types in the data dictionary.

In the Scade model the ETCS language is available in the oETCS projects S026-7 and S026-8.

\subsection{Data Dictionary Outlook}
In the first iteration the use of the data dictionary concept is reduced to a minimum. The full openETCS process is tailored for a bigger team to cooperate and make use of tools to collect data and generate code. 

In the Scade model the types needed to build the interface between models are defined in the projects Obu\_Basic\_Types.etp, BG\_Types.etp, and TrainPosition\_Types.etp.


\chapter{openETCS Kernel Functions}

\section{openETCS Model Runtime System}
The openETCS model runtime system also provides:

\begin{itemize}
\item Input Functions from other Units\\\marginpar{maybe use a description}
In this entity messages from other connected units are received.
\item Output Functions to other Units\\
The entity writes messages to other connected units.
\item Conversation Functions for Messages (Bitwalker)\\
The conversion function are triggered by Input and Ouput Functions. The main task is to convert input messages from an bit-packed format into logical ETCS messages (the ETCS language) and Output messages from Logical into a bit-packed format. The logical format of the messages is defined for all used types in the openETCS data dictionary. \\
Variable size elements in the Messages are converted to fixed length arrays with an used elements indicator.\\
Optional elements are indicated with an valid flag.
The conversion routines are responsible for checking the data received is valid. If  faults are detected the information is passed to the openETCS executable model for further reaction. 
\item Model Cycle\\
The executable model is called in cycles. In the cycle 
\begin{itemize}
\item First the received input messages are decoded.
\item The input data is passed to the executable model in a predefined order. \textbf{(Details for the interface to be defined)}.
\item Output is encoded according to the SRS and passed to the  buffers to the units.
\end{itemize}

%==================================================================
\end{itemize}

\input{sections/GenericAPI.tex}


\section{First Iteration: Used API Functions and Interfaces to the Basic Software}
Note: The basic functions and the API is not implemented in the first iteration. Instead, the Scade test environment is used for this purpose. However, the interface used in the model is described as if they were available.

\begin{enumerate}
\item Runtime System\\
The Runtime System calls the openETCS kernel model in a cyclic way. Input parameters are updated with every cycle.
\item Input
\begin{enumerate}
\item Control Interface\\
The control interface triggers the reset of the application software. The reset is modelled as reset flag in the Scade model.

\item BTM Services\\
The BTM service passes decoded telegrams to the executable model. The telegram is handed over to the API\_balise parameter of the model (see Chapter~\ref{ss:ReceiveEurobaliseFromAPI}). In each cycle only one telegram is expected to be passed. For details in the interfaces\marginpar{??}, The application may need the service brake function. The trigger needs to be passed to a corresponding function inside the application software (not part of the kernel)

\item Odometry\\
The input from the odometry is updated with every cycle\marginpar{cycle=clock?}. The information from the odometry is updated in the parameter actual\_odometry of the executable model.
\end{enumerate}

\item Output
\begin{enumerate}
\item Runtime System\\
\item DMI\\
The application may indicate errors at the balise group interface to the driver. The trigger needs to be passed to a corresponding function inside the application software (not part of the kernel).
\item Train Interface Unit (TIU)\\
The application may need the service brake function. The trigger needs to be passed to a corresponding function inside the application software (not part of the kernel).
\item EuroRadio\\
The application may trigger the position report via radio interface. The message needs to be passed to a corresponding function inside the application software (not part of the kernel).
\end{enumerate}

\end{enumerate}

\section{First Iteration: Interfaces to other Functions of the Application Software (not part of First Iteration)}
This section mainly refers to interfaces replaced by data implemented in the model.

\begin{enumerate}
\item Train-Info\\
The parameters of the train are seen as a constant to the kernel model. The data re not changed by any function of the kernel model. Only data used in the kernel are listed here.
Used Information:
\begin{enumerate}
\item Level = 1\\
\item Mode = \marginpar{?}\\
\end{enumerate}
\end{enumerate}

\FIXME{diagram to be added}

\section{F.1 Manage Balise Information}
This function manages telegrams of the balise channel. 
Diagram needs to be added.

\begin{enumerate}
\item Functional Description
\item Reference to teh Standards
\item Deviations from the Standards, Open Issues
\item Input
\item Output
\item Data
\end{enumerate}

\subsection{F.1.1 Receive Eurobalise From API}\label{ss:ReceiveEurobaliseFromAPI}

\begin{figure}[hbtp]
\centering
\includegraphics[width=.9\textwidth]{../images/ReceiveEuroBaliseFromAPI_diagram.png}
\caption{Structure of ReceiveEuroBaliseFromAPI}
\end{figure}

\subsubsection{Short Description of Functionality}
This function defines the interface of the OBU model to the openETCS generic API for Eurobalise Messages. On the interface, either a valid telegram is provided or a telegram is indicated which could not be received correct when passing the balise. The function passes the telegram without major changes of the information to the next entity for collecting the balise group information.
	
\subsubsection{Reference to the SRS (or other requirements)}

\subsubsection{Design Constrains and Choices}

\begin{enumerate}
\item The decoding of balises is done at the API. Also, packets received via the interface are already transformed into a usable shape.
\item Only packets used inside the current model are passed via the interface:\\
Packet 5: Linking Information.\\
Linking Information is added to the linking array starting from index 0 without gaps. Used elements are marked as valid. Elements are sorted according to the order given by the telegram sequence.
\end{enumerate}



\subsection{F.1.2 Build BG Group Message}

\begin{figure}[hbtp]
\centering
\includegraphics[width=\textwidth]{../images/BuildBGMessage_diagram.png}
\caption{Structure of BuildBGMessage}
\end{figure}

\subsubsection{Short Description of Functionality}
This entity collects telegrams received via the interface into Balise Group Information.
	
\subsubsection{Reference to the SRS (or other requirements)}
\subsubsection{Design Constrains and Choices}
\begin{enumerate}
\item Telegrams received as invalid are passed to the ``Check-Function'' to process errors in communication with the track side according to the requirements and in a single place.
Telegrams are added to the telegram array starting from index 0 without gaps. Used elements are marked as valid. Elements are stored according to the order given by the telegram sequence.
\item This function does not process information from the packets. The information is passed to the check without further processing of the values. 
\end{enumerate}



\subsection{F.1.3 Check BG Consistency}

\subsubsection{Short Description of Functionality}
\subsubsection{Reference to the SRS (or other requirements)}
\subsubsection{Design Constrains and Choices}

%\begin{enumerate}
%\item Only packets used inside the current model are passed via the interface:\\
%Packet 5: Linking Information.\\
%\item In this function packets past with the telegrams is accumulated into a balise group information.\\
%\item Further assumption on packet 5 (based on SRS subset 26, section 8.4.1.4)\\
%(In this statement the term ``message'' is ambiguous since it can reflect to a telegram or a balise group message)
%Linking Information can only be passed once. This means, if linking information for the balise group is already collected with one of the earlier telegrams, the information will not be accumulated but overwritten.\\
%\end{enumerate}


\subsection{F.1.4 Determine BG- Orientation and LRBG}

\subsubsection{Short Description of Functionality}
\subsubsection{Reference to the SRS (or other requirements)}
\subsubsection{Design Constrains and Choices}


\subsection{F.1.5 Select Useable Info}

\subsubsection{Short Description of Functionality}
The function Select Useable Info filters information received from balises that have been passed, radio, and EUROLOOP. Filtering is done depending on the mode of the train, the current ETCS level, the type/content of the information, and the transition media of the information. As neither radio messages nor EUROLOOP are part of the first iteration of work, not all functionality of the filter described in the specification is currently implemented.

\subsubsection{Reference to the SRS (or other requirements)}
The functionality of Select Useable Info is described in Chapter 4.8 of the SRS. The following list gives an overview of the most important sections for each of the blocks in the model.

\begin{description}
\item[First filter] The first filter, i.e., the filter on the level, is described in \cite[Chapter~4.8.3]{subset-026}.
\item[Second filter] The second filter, i.e., the filter on the transition media, is described in\cite[Chapter~4.8.3]{subset-026}.
\item[Third filter]
 The second filter, i.e., the filter on the modes, is described in \cite[Chapter~4.8.4]{subset-026}.
\item[Transition buffers] Details on the handling of the transition buffers used in the first and the second filter are described in \cite[Chapter~4.8.5]{subset-026}.
\end{description}

\subsubsection{Design Constrains and Choices}
The first iteration of the model takes only balise group messages into account. This implies that a large part of the specification of this function described in \cite{subset-026} is not relevant for the first iteration. This in particular applies to the filter on the transition medium, because radio messages are not part of the model so far, and to the filter on level, because the first iteration of the model implements only ETCS level 1.

\section{F.2 Manage Train Position}


\subsection{F.2.1 Validate Data Direction}

\subsubsection{Short Description of Functionality}
\subsubsection{Reference to the SRS (or other requirements}
\subsubsection{Design Constrains and Choices}

\input{sections/trainPosition.tex}

\appendix

%\nocite{*}
\bibliographystyle{unsrt}
%\bibliographystyle{plain}
%\bibliographystyle{alpha}
%\bibliographystyle{annotate}
%\bibliographystyle{klunamed}
\bibliography{architecture}

\newpage
\addcontentsline{toc}{chapter}{Index}
\printindex

%===================================================
%Do NOT change anything below this line

\end{document}
